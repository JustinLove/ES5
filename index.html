<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" 
                    "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
  <link rel="stylesheet" href="qunit/qunit.css" type="text/css" media="screen" />
<script type="text/javascript" src="qunit/qunit.js"></script>

<script type="text/javascript" src="es5.js"></script>

  <script>

var es5 = exports;

test("got a module", function() {
  ok(es5);
});

function throwsTypeError(o, f, args) {
  test(f + " does typechecking", function() {
    try {
      o[f].apply(o, args);
      ok(false, "should have thrown TypeError");
    } catch (e) {
      ok(e instanceof TypeError, "caught TypeError");
    }
  });
}

function stub(o, f) {
  throwsTypeError(o, f, [1]);
  var x = {};
  test(f + " stubbed", function() {
    equals(o[f].apply(o, [x]), x);
  });
}

function queryStub(o, f, result) {
  throwsTypeError(o, f, [1]);
  test(f + " stubbed", function() {
    equals(o[f].apply(o, [x]), result);
  });
}

function testPropertyDescriptor(desc, value, prefix) {
  expect(0);

  test(prefix + " truthy", function() {
    ok(desc);
  });

  test(prefix + " value property", function() {
    equals(desc.value, 1);
  });

  test(prefix + " writeable property", function() {
    equals(desc.writeable, true);
  });

  test(prefix + " enumerable property", function() {
    equals(desc.enumerable, true);
  });

  test(prefix + " configurable property", function() {
    equals(desc.configurable, true);
  });
}

function usesThreeArgumentCallback(name) {
  test(name + " calls with specified object", function() {
    expect(1);
    var x = {};
    es5.Array.prototype[name].call([true], function() {return equals(this, x);}, x);
  });

  test(name + " should have undefined this, but the engine supplies [window] even if we try to pass undefined", function() {
    expect(1);
    es5.Array.prototype[name].call([true], function() {return same(this, {});});
  });

  test(name + " passes value as first argument", function() {
    expect(1);
    es5.Array.prototype[name].call([true], function(v) {return equals(true, v);});
  });

  test(name + " passes index as first argument", function() {
    expect(1);
    es5.Array.prototype[name].call([true], function(v, i) {return equals(0, i);});
  });

  test(name + " passes array as third argument", function() {
    expect(1);
    var x = [true];
    es5.Array.prototype[name].call(x, function(v, i, a) {return equals(x, a);});
  });

  var x = [];
  x.every = es5.Array.prototype[name];
  throwsTypeError(x, name, [1]);
}

module("Object");
test("Object", function() {
  ok(es5.Object);

  throwsTypeError(es5.Object, 'getPrototypeOf', [1]);

  test("getPrototypeOf", function() {
    equals(es5.Object.getPrototypeOf({}), Object.prototype);
  });

  throwsTypeError(es5.Object, 'getOwnPropertyDescriptor', [1]);

  test("getOwnPropertyDescriptor", function() {
    var x = {a: 1, b: 2};
    var a = es5.Object.getOwnPropertyDescriptor(x, 'a');
    testPropertyDescriptor(a, 1, 'getOwnPropertyDescriptor');
  });

  throwsTypeError(es5.Object, 'getOwnPropertyNames', [1]);

  test("getOwnPropertyNames", function() {
    var F = function(){};
    F.prototype = {z:26};
    var x = new F();
    x.a = 1;
    x.b = 2;

    var names = es5.Object.getOwnPropertyNames(x);
    same(names, ['a', 'b']);
  });

  throwsTypeError(es5.Object, 'create', [1]);

  test("create with null", function() {
    ok(es5.Object.create());
  });

  test("create with an object", function() {
    var x = {};
    var y = es5.Object.create(x);
    ok(x === es5.Object.getPrototypeOf(y), "Prototype match");
  });

  test("create with properties", function() {
    var x = es5.Object.create(null, {a: {value: 1}});
    equals(x.a, 1);
  });

  throwsTypeError(es5.Object, 'defineProperty', [1]);

  test("defineProperty", function() {
    var x = {};
    es5.Object.defineProperty(x, 'a', {value: 1});
    equals(x.a, 1);
  });

  test("defineProperty returns the object", function() {
    var x = {};
    equals(es5.Object.defineProperty(x, 'a'), x);
  });

  throwsTypeError(es5.Object, 'defineProperties', [1]);

  test("defineProperties", function() {
    expect(2);
    x = {};
    es5.Object.defineProperties(x, {a: {value: 1}, b: {value: 2}});
    equals(x.a, 1);
    equals(x.b, 2);
  });

  test("defineProperties returns the object", function() {
    var x = {};
    equals(es5.Object.defineProperties(x, {a: {}}), x);
  });

  stub(es5.Object, 'seal');
  stub(es5.Object, 'freeze');
  stub(es5.Object, 'preventExtensions');

  queryStub(es5.Object, 'isSealed', false);
  queryStub(es5.Object, 'isFrozen', false);
  queryStub(es5.Object, 'isExtensible', true);

  throwsTypeError(es5.Object, 'keys', [1]);

  test("keys", function() {
    var F = function(){};
    F.prototype = {z:26};
    var x = new F();
    x.a = 1;
    x.b = 2;

    var names = es5.Object.keys(x);
    same(names, ['a', 'b', 'z']);
  });
});

module("Function");
test("Function", function() {
  throwsTypeError(es5.Function.prototype, 'bind');
  
  test("bind returns a function", function() {
    var f = function(){};
    var g = es5.Function.prototype.bind.call(f, {});
    equals(typeof(g), 'function');
  });

  test("bound function is passed function", function() {
    var f = function(){return 'pass';};
    var g = es5.Function.prototype.bind.call(f, {});
    equals(g(), 'pass');
  });

  test("bound function operates on specified object", function() {
    var x = {a: 1};
    var f = function(){return this;};
    var g = es5.Function.prototype.bind.call(f, x);
    equals(g(), x);
  });

  test("bound function operates on specified arguments", function() {
    var f = function(a){return a;};
    var g = es5.Function.prototype.bind.call(f, null, 1);
    equals(g(), 1);
  });

  test("bound function takes new arguments", function() {
    var f = function(a){return a;};
    var g = es5.Function.prototype.bind.call(f, null);
    equals(g(2), 2);
  });

  test("bind adjusts length", function() {
    var f = function(a, b){};
    var g = es5.Function.prototype.bind.call(f, null, 1);
    equals(g.length, 1);
  });

  test("length of bind is 1", function() {
    equals(es5.Function.prototype.bind.length, 1);
  });
});

module("Array");
test("Array", function() {
  test("objects are not arrays", function() {
    equals(es5.Array.isArray({}), false);
  });

  test("arrays are arrays", function() {
    equals(es5.Array.isArray([]), true);
  });

  test("indexOf found", function() {
    equals(es5.Array.prototype.indexOf.call([0, 1, 2, 1], 1), 1);
  });

  test("indexOf not found", function() {
    equals(es5.Array.prototype.indexOf.call([0, 1, 2, 1], 42), -1);
  });

  test("indexOf empty", function() {
    equals(es5.Array.prototype.indexOf.call([], 42), -1);
  });

  test("indexOf from", function() {
    equals(es5.Array.prototype.indexOf.call([0, 1, 2, 1], 1, 2), 3);
  });

  test("indexOf from negative", function() {
    equals(es5.Array.prototype.indexOf.call([0, 1, 2, 1], 1, -2), 3);
  });

  test("indexOf from past the end", function() {
    equals(es5.Array.prototype.indexOf.call([0, 1, 2, 1], 1, 4), -1);
  });


  test("lastIndexOf found", function() {
    equals(es5.Array.prototype.lastIndexOf.call([2, 1, 2, 3], 2), 2);
  });

  test("lastIndexOf not found", function() {
    equals(es5.Array.prototype.lastIndexOf.call([2, 1, 2, 3], 42), -1);
  });

  test("lastIndexOf empty", function() {
    equals(es5.Array.prototype.lastIndexOf.call([], 42), -1);
  });

  test("lastIndexOf from", function() {
    equals(es5.Array.prototype.lastIndexOf.call([2, 1, 2, 3], 2, 1), 0);
  });

  test("lastIndexOf from negative", function() {
    equals(es5.Array.prototype.lastIndexOf.call([2, 1, 2, 3], 2, -3), 0);
  });

  test("lastIndexOf from past the end", function() {
    equals(es5.Array.prototype.lastIndexOf.call([2, 1, 2, 3], 1, 0), -1);
  });


  test("every can return true", function() {
    equals(es5.Array.prototype.every.call([true, true], function(v) {return v;}), true);
  });

  test("every can return false", function() {
    equals(es5.Array.prototype.every.call([false, true], function(v) {return v;}), false);
  });

 test("every is true for empty array", function() {
    equals(es5.Array.prototype.every.call([], function() {return false;}), true);
  });

  usesThreeArgumentCallback('every');


  test("some can return true", function() {
    equals(es5.Array.prototype.some.call([false, true], function(v) {return v;}), true);
  });

  test("some can return false", function() {
    equals(es5.Array.prototype.some.call([false, false], function(v) {return v;}), false);
  });

  test("some is false for empty array", function() {
    equals(es5.Array.prototype.some.call([], function() {return true;}), false);
  });

  usesThreeArgumentCallback('some');


  usesThreeArgumentCallback('forEach');
});

module("echo");

  </script>
  
</head>
<body>
 <h1 id="qunit-header">EcmaScript 5 in 3</h1>
 <h2 id="qunit-banner"></h2>
 <h2 id="qunit-userAgent"></h2>
 <ol id="qunit-tests"></ol>
</body>
</html>
</html>